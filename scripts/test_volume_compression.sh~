#!/bin/bash

#VICCOMPRESS="../test_volume_compression/vic_test_volume_compression"
VICCOMPRESS="./vic_volume_sparse_codec"

#=============================================================================================
#INPUT_DIR="/mnt/tdm-vic/nobackup/ext/vol/dynamic/JHTDB/isotropic-velocity-magnitude/"
#STATS_DIR="/mnt/tdm-vic/scratch/vic/rockdvr/stats_0256/"

#INPUT_DIR="/data/raw_volume"
#STATS_DIR="/data/raw_volume/volume_sparse_codec_test"
#INPUT_FILE="engine"

if [ $# -ne 3 ]; then
    echo Wrong parameter count: Usage test_volume_sparse_codec.sh INPUT_DIR INPUT_FILE OUTPUT_DIR 
    exit
fi

INPUT_DIR=$1
INPUT_FILE=$2
STATS_DIR=$3

#=============================================================================================

#for FRAME in 0000 0128 0256 0384 0512 0640 0768 0896 1023
#for FRAME in 0128 0384 0640 0896


#INPUT_FILE="isotropic_velocity_magnitude_fp32_t"$FRAME

# =================================================== KSVD  ===========================================
for ROCKDVR_CONDITION in "-K 8" "-a 6" "-T 0.01"
do
    for ROCKDVR_DICT in 2048
    do
	for ROCKDVR_ALLOC in fixed greedygrow
	do
	    for ROCKDVR_CORESET in 16
	    do
                for QUANTIZATION in none covra rockdvr-eurovis rockdvr-cag
                do
		    VICARGS="-I 30 -C $ROCKDVR_CORESET -D $ROCKDVR_DICT -P 4 -B 6 -b 6 -Q 1 -e $ROCKDVR_ALLOC -q $QUANTIZATION $ROCKDVR_CONDITION"
		    VICARGSTRING=`echo "$VICARGS" | tr ' \.' '_'  | tr -d '\-'`
		    
		    VICOUTPUT_FILE=$INPUT_FILE"_vic_"$VICARGSTRING
		    VICOUTPUT_FILE_STATS=$VICOUTPUT_FILE".stats"
		    VICOUTPUT_FILE_LOG=$VICOUTPUT_FILE".log"
		    
		    echo "================================================="    
		    echo "-------- Running " $VICCOMPRESS $VICARGS " on " $INPUT_FILE
		    
		    echo "########### STATS FOR " $INPUT_FILE " ######" > $STATS_DIR/$VICOUTPUT_FILE_STATS
		    echo "########### LOG FOR " $INPUT_FILE " ######" > $STATS_DIR/$VICOUTPUT_FILE_LOG
		    
		    echo "#" $VICARGS $INPUT_DIR/$INPUT_FILE | tee -a $STATS_DIR/$VICOUTPUT_FILE_STATS
                    $VICCOMPRESS $VICARGS $INPUT_DIR/$INPUT_FILE 2>>$STATS_DIR/$VICOUTPUT_FILE_LOG | tee -a $STATS_DIR/$VICOUTPUT_FILE_STATS
                    #               		echo $VICCOMPRESS $VICARGS $INPUT_DIR/$INPUT_FILE 2 su $STATS_DIR/$VICOUTPUT_FILE_LOG T su  $STATS_DIR/$VICOUTPUT_FILE_STATS

                    RET_VAL=$?
                    echo
                    if [ $RET_VAL -eq 0 ]; then
	                echo OK
                    else
                        echo =========== FAILED ==============
                    fi
		done
	    done
	done
    done
done
